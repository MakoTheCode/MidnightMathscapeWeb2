<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Additional styles that weren't in dashboard.css */
        :root {
            --color-primary: #8A1532;
            --color-secondary: #F4F4F4;
            --color-accent: #09ffce;
            --color-text-light: #F0FFDD;
            --color-text-dark: #501121;
            --color-text-gray: #7f7f7f;
            --color-primary-p-50: #f9f2f4;
        }
        
        .main-menu img {
            display: block;
            margin: 0 auto 15px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            object-fit: cover;
        }
        
        .main-menu h2 {
            margin-bottom: 5px;
        }
        
        .main-menu > p {
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
       
        
        .main-section a:hover, .settings-section a:hover {
            background: rgba(255,255,255,0.1);
        }
        
      
        
        #studlist {
            background: rgba(255,255,255,0.15);
            font-weight: 600;
        }
        
       
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .input-group label {
            font-weight: 500;
        }

        .input-group select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            min-width: 200px;
            color: var(--color-primary);
            font-weight: 600;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group select:focus {
            border-color: #66a6ff;
            box-shadow: 0 0 8px rgba(102, 166, 255, 0.3);
            outline: none;
        }

        .search-container {
            position: relative;
            max-width: 400px;
            margin-bottom: 20px;
            margin-left: 20px;
            margin-top: 20px;
            float: left;
        }

        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-gray);
        }

        .search-container input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .search-container input:focus {
            border-color: #66a6ff;
            box-shadow: 0 0 8px rgba(102, 166, 255, 0.3);
            outline: none;
        }

        .data-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .total-students {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 15px;
            color: var(--color-primary);
        }

        .data-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 0.5fr 1fr;
            gap: 15px;
            padding: 15px;
            background: #f8f8f8;
            border-radius: 8px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .student-list {
            max-height: 50vh;
            overflow-y: auto;
        }

        .student-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 0.5fr 1fr;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #eee;
            align-items: center;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .status-active {
            color: #27ae60;
            font-weight: 500;
        }

        .status-inactive {
            color: #e74c3c;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .no-students {
            text-align: center;
            padding: 30px;
            color: #777;
            font-style: italic;
        }

        .student-list::-webkit-scrollbar {
            width: 8px;
        }

        .student-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .student-list::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: 10px;
        }

        .student-list::-webkit-scrollbar-thumb:hover {
            background: #501121;
        }

        @media (max-width: 992px) {
            .data-header, .student-item {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .container-wrap {
                display: flex;
                flex-direction: column;
            }
            
           
            .input-group {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            
            .data-header, .student-item {
                grid-template-columns: 1fr;
            }
            
            .header-title h1 {
                font-size: 2rem;
            }
            
           
            
            .info {
                font-size: 1.2rem;
                margin-left: 0;
            }
        }

        @media (max-width: 576px) {
            .top-bar {
                flex-direction: column;
                height: auto;
              
            }
            
            .logout {
                margin-top: 10px;
                margin-right: 0;
            }
            
          
            
            .header-title h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-wrap">
        <!-- Main Navigation -->
        <div class="-main">
            <div class="main-menu">
                <img src="Website & Codes\images\profile logo.PNG">
                <h2 id="displayName">Loading...</h2>
                <p>Math Teacher</p>
                
                <!-- Main Section -->
                <div class="main-section">
                    <p>Main</p>
                    <a id="studlist" href="studentList.html">Student List</a>
                    <a id="studprog" href="studentProgress.html">Student Progress</a>
                    <a id="evalcontrol" href="evalControl.html">Evaluation & Control</a>
                    <a id="accsetup" href="accSecSetup.html">Account & Section Setup</a>
                </div>
                
                <!-- Settings Section -->
                <div class="settings-section">
                    <p>Settings</p>
                    <a id="settings" href="settingsPage.html">Account Settings</a>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="-side">
            <!-- Top Navigation Bar -->
            <div class="top-bar">
                <div class="info">
                    <span id="userRole">Loading role...</span>
                </div>
                
                <!-- Logout -->
                <div class="logout">
                    <a href="mainWeb.html" id="logoutBtn">Logout</a>
                    <i class="fas fa-sign-out-alt"></i>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dash-window">
                <div class="header-title">
                    <h1>Student List</h1>
                </div>
                
                <!-- Grade and Section Selection -->
                <div class="input-group">
                    <label for="gradeSelect">Grade:</label>
                    <select name="gradeSelect" id="gradeSelect">
                        <option value="">Select Grade</option>
                        <option value="Grade 1">Grade 1</option>
                        <option value="Grade 2">Grade 2</option>
                        <option value="Grade 3">Grade 3</option>
                        <option value="Grade 4">Grade 4</option>
                        <option value="Grade 5">Grade 5</option>
                        <option value="Grade 6" selected>Grade 6</option>
                    </select>
                    
                    <label for="sectionSelect">Section:</label>
                    <select name="sectionSelect" id="sectionSelect">
                        <option value="">Loading sections...</option>
                    </select>
                </div>

                <!-- Search Bar -->
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="search" id="searchInput" placeholder="Search students by name or ID...">
                </div>

                <!-- Student List -->
                <div class="data-container">
                    <div class="total-students" id="totalStudents">Total Students: 0</div>
                    
                    <div class="data-header">
                        <h3>Student ID</h3>
                        <h3>Last Name</h3>
                        <h3>First Name</h3>
                        <h3>M.I.</h3>
                        <h3>Account Status</h3>
                    </div>
                    
                    <div class="student-list" id="studentList">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Select a section to view students
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBkmM4hueT7PlnvV8FeRdp8g4rk0qQQrn4",
            authDomain: "midnightmathscape.firebaseapp.com",
            databaseURL: "https://midnightmathscape-default-rtdb.firebaseio.com",
            projectId: "midnightmathscape",
            storageBucket: "midnightmathscape.appspot.com",
            messagingSenderId: "1038485290511",
            appId: "1:1038485290511:web:c8aa78fbcd5266b706ed7a",
            measurementId: "G-WXGW44QMRD"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let isAdminUser = false;
        let currentStudents = [];
        let currentSections = [];

        // Check if user is admin
        async function checkAdminStatus() {
            const user = auth.currentUser;
            if (!user) return false;
            
            // Check if email is admin email
            if (user.email === 'admin@stmichael.edu.ph') return true;
            
            // Check Firestore for admin role
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                return userDoc.exists && userDoc.data().role === 'admin';
            } catch (error) {
                console.error("Error checking admin status:", error);
                return false;
            }
        }

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            // Check auth state
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("User authenticated:", user.uid);
                    currentUser = user;
                    const displayName = user.displayName || user.email.split('@')[0];
                    document.getElementById('displayName').textContent = displayName;
                    
                    // Set user role in UI
                    isAdminUser = await checkAdminStatus();
                    document.getElementById('userRole').textContent = isAdminUser ? 'Administrator' : 'Teacher';
                    
                    try {
                        // Load sections based on user role
                        await loadSections();
                    } catch (error) {
                        console.error("Initialization error:", error);
                        showError("Could not initialize. Please refresh the page.");
                    }
                } else {
                    console.log("No user signed in, redirecting to login");
                    window.location.href = 'mainWeb.html';
                }
            });

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                auth.signOut().then(() => {
                    window.location.href = 'mainWeb.html';
                });
            });

            // Grade selection change
            document.getElementById('gradeSelect').addEventListener('change', function() {
                loadSections();
            });

            // Section selection change
            document.getElementById('sectionSelect').addEventListener('change', function() {
                const selectedSection = this.value;
                if (selectedSection) {
                    loadStudents(selectedSection);
                } else {
                    document.getElementById('studentList').innerHTML = 
                        '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Select a section to view students</div>';
                    document.getElementById('totalStudents').textContent = 'Total Students: 0';
                }
            });

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                filterStudents(searchTerm);
            });
        });

        // Load sections from Firestore
        async function loadSections() {
            const gradeSelect = document.getElementById('gradeSelect');
            const sectionSelect = document.getElementById('sectionSelect');
            const selectedGrade = gradeSelect.value;
            
            sectionSelect.innerHTML = '<option value="">Loading sections...</option>';
            
            try {
                let query = db.collection('sections');
                
                // If a grade is selected, filter by grade
                if (selectedGrade) {
                    query = query.where('grade', '==', selectedGrade);
                }
                
                // If not admin, only show sections assigned to the teacher
                if (!isAdminUser) {
                    query = query.where('teacherId', '==', currentUser.uid);
                }
                
                const querySnapshot = await query.get();
                
                if (querySnapshot.empty) {
                    sectionSelect.innerHTML = '<option value="">No sections found</option>';
                    return;
                }
                
                // Store sections for later use
                currentSections = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    currentSections.push({
                        id: doc.id,
                        name: data.name,
                        grade: data.grade
                    });
                });
                
                // Populate section dropdown
                sectionSelect.innerHTML = '<option value="">Select a section</option>';
                currentSections.forEach(section => {
                    const option = document.createElement('option');
                    option.value = section.id;
                    option.textContent = `${section.name} (${section.grade})`;
                    sectionSelect.appendChild(option);
                });
                
                // Check if there's a section ID in the URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const sectionId = urlParams.get('sectionId');
                
                if (sectionId) {
                    // Check if this section exists in our list
                    const sectionExists = currentSections.some(s => s.id === sectionId);
                    if (sectionExists) {
                        sectionSelect.value = sectionId;
                        loadStudents(sectionId);
                    }
                }
            } catch (error) {
                console.error("Error loading sections:", error);
                sectionSelect.innerHTML = '<option value="">Error loading sections</option>';
            }
        }

        // Load students from selected section
        async function loadStudents(sectionId) {
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Loading students...</div>';
            
            try {
                // Get section details first
                const sectionDoc = await db.collection('sections').doc(sectionId).get();
                if (!sectionDoc.exists) {
                    studentList.innerHTML = '<div class="no-students">Section not found</div>';
                    return;
                }
                
                const sectionData = sectionDoc.data();
                console.log("Section data:", sectionData);
                
                // Try multiple approaches to find students in this section
                let querySnapshot;
                
                // Approach 1: Try section ID field
                querySnapshot = await db.collection('students')
                    .where('sectionId', '==', sectionId)
                    .get();
                
                // If no results, try section name and grade combination
                if (querySnapshot.empty) {
                    console.log("No students found with sectionId, trying section name and grade...");
                    
                    querySnapshot = await db.collection('students')
                        .where('section.name', '==', sectionData.name)
                        .where('section.grade', '==', sectionData.grade)
                        .get();
                }
                
                // If still no results, try just the section name
                if (querySnapshot.empty) {
                    console.log("No students found with section name and grade, trying just section name...");
                    
                    querySnapshot = await db.collection('students')
                        .where('section', '==', sectionData.name)
                        .get();
                }
                
                // If still no results, try the section reference format
                if (querySnapshot.empty) {
                    console.log("No students found with section name, trying section reference format...");
                    
                    const sectionRef = `${sectionData.grade.replace(/\s+/g, '')}_${sectionData.name.replace(/\s+/g, '')}`;
                    console.log("Looking for sectionRef:", sectionRef);
                    
                    querySnapshot = await db.collection('students')
                        .where('section.sectionId', '==', sectionRef)
                        .get();
                }
                
                if (querySnapshot.empty) {
                    studentList.innerHTML = `
                        <div class="no-students">
                            No students found in this section.<br>
                            <small>Please check if students are properly assigned to this section.</small>
                        </div>
                    `;
                    document.getElementById('totalStudents').textContent = 'Total Students: 0';
                    currentStudents = [];
                    return;
                }
                
                // Process students
                currentStudents = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log("Student data:", data);
                    currentStudents.push({
                        id: doc.id,
                        studentId: data.studentId || 'N/A',
                        lastName: data.lastName || '',
                        firstName: data.firstName || '',
                        middleInitial: data.middleInitial || '',
                        status: data.status || data.accountStatus || 'inactive'
                    });
                });
                
                // Update total count
                document.getElementById('totalStudents').textContent = `Total Students: ${currentStudents.length}`;
                
                // Render students
                renderStudents(currentStudents);
            } catch (error) {
                console.error("Error loading students:", error);
                studentList.innerHTML = '<div class="no-students">Error loading students. Please try again.</div>';
            }
        }

        // Render students to the UI
        function renderStudents(students) {
            const studentList = document.getElementById('studentList');
            
            if (students.length === 0) {
                studentList.innerHTML = '<div class="no-students">No students match your criteria</div>';
                return;
            }
            
            studentList.innerHTML = '';
            
            students.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'student-item';
                
                studentItem.innerHTML = `
                    <div>${student.studentId}</div>
                    <div>${student.lastName}</div>
                    <div>${student.firstName}</div>
                    <div>${student.middleInitial}</div>
                    <div class="status-${student.status}">${student.status === 'active' ? 'Active' : 'Inactive'}</div>
                `;
                
                studentList.appendChild(studentItem);
            });
        }

        // Filter students based on search term
        function filterStudents(searchTerm) {
            if (!searchTerm) {
                renderStudents(currentStudents);
                document.getElementById('totalStudents').textContent = `Total Students: ${currentStudents.length}`;
                return;
            }
            
            const filteredStudents = currentStudents.filter(student => {
                return (
                    student.studentId.toLowerCase().includes(searchTerm) ||
                    student.lastName.toLowerCase().includes(searchTerm) ||
                    student.firstName.toLowerCase().includes(searchTerm)
                );
            });
            
            renderStudents(filteredStudents);
            document.getElementById('totalStudents').textContent = `Total Students: ${filteredStudents.length}`;
        }

        // Show error message
        function showError(message) {
            const studentList = document.getElementById('studentList');
            if (studentList) {
                studentList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        <p>${message}</p>
                        <button onclick="window.location.reload()" style="color: #8A1532; background: none; border: none; text-decoration: underline; cursor: pointer;">
                            Try again
                        </button>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>